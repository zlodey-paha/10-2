global
    daemon
    maxconn 4000
    log /dev/log local0 info
    stats socket /var/run/haproxy/admin.sock mode 660 level admin

defaults
    mode http
    log global
    option httplog
    option dontlognull
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    retries 3
    option redispatch

# Статистика HAProxy
listen stats
    bind *:1936
    mode http
    stats enable
    stats hide-version
    stats refresh 30s
    stats show-node
    stats auth admin:password
    stats uri /haproxy?stats

# Frontend для HTTP балансировки с привязкой к домену
frontend http_front
    bind *:80
    mode http
    
    # Балансировка только для домена example.local
    acl is_example_local hdr(host) -i example.local
    
    # Перенаправляем трафик для example.local в бэкенд
    use_backend http_servers if is_example_local
    
    # Для остального трафика - 404 или редирект
    default_backend invalid_domain

# Backend с Weighted Round Robin
backend http_servers
    mode http
    balance roundrobin
    option httpchk GET /health
    
    # Weighted Round Robin: server1=2, server2=3, server3=4
    server server1 127.0.0.1:8081 weight 2 check inter 2000 fall 3 rise 2
    server server2 127.0.0.1:8082 weight 3 check inter 2000 fall 3 rise 2  
    server server3 127.0.0.1:8083 weight 4 check inter 2000 fall 3 rise 2
    
    # Логирование для отладки балансировки
    capture request header Host len 32
    capture request header User-Agent len 64
    http-request capture req.hdr(X-Forwarded-For) len 15

# Backend для неверных доменов
backend invalid_domain
    mode http
    errorfile 503 /etc/haproxy/errors/403.http

# Backend для мониторинга (прямой доступ к серверам)
backend direct_access
    mode http
    server direct_server 127.0.0.1:8080